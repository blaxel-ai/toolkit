name: Windows CLI E2E Test

on:
  workflow_dispatch:

jobs:
  windows-cli-e2e:
    runs-on: windows-latest
    env:
      BL_API_KEY: ${{ secrets.BL_API_KEY }}
      BL_WORKSPACE: ${{ secrets.BL_WORKSPACE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"
          check-latest: true
          cache: true

      - name: Build CLI
        run: |
          go build -o bl.exe .
          echo "${{ github.workspace }}" >> $env:GITHUB_PATH

      - name: Verify CLI
        run: bl version

      - name: Login to Blaxel
        run: bl login ${{ secrets.BL_WORKSPACE }}

      - name: Create agent from template
        run: |
          $agentName = "ci-win-test-${{ github.run_id }}"
          echo "AGENT_NAME=$agentName" >> $env:GITHUB_ENV
          bl new agent $agentName -t template-blank-ts -y

      - name: Deploy agent
        working-directory: ci-win-test-${{ github.run_id }}
        run: bl deploy -y

      - name: Wait for deployment to be ready
        run: |
          $agentName = "ci-win-test-${{ github.run_id }}"
          $timeout = 600  # 10 minutes
          $interval = 20  # poll every 20s
          $elapsed = 0
          Write-Host "Waiting for agent $agentName to be deployed (timeout: ${timeout}s)..."
          while ($elapsed -lt $timeout) {
            $output = bl get agents $agentName 2>&1 | Out-String
            Write-Host "[$elapsed`s] Status check: $output"
            if ($output -match "DEPLOYED") {
              Write-Host "Agent deployed successfully after ${elapsed}s"
              exit 0
            }
            if ($output -match "FAILED") {
              Write-Host "Agent deployment failed"
              exit 1
            }
            Start-Sleep -Seconds $interval
            $elapsed += $interval
          }
          Write-Host "Deployment timed out after ${timeout}s"
          exit 1

      - name: View agent logs
        run: bl logs agent ci-win-test-${{ github.run_id }} --period 5m

      - name: Cleanup - Delete agent
        if: always()
        run: bl delete agent ci-win-test-${{ github.run_id }}
